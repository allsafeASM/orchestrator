import logging
import traceback
import azure.functions as func
import os
import json
from azure.storage.blob import BlobServiceClient
from database.db_manager import DatabaseManager

app = func.Blueprint()

@app.activity_trigger(input_name="payload")
async def save_vulnerability_scan_results(payload: dict):
    try:
        scan_context = payload["scan_context"]
        nuclei_blob_path = payload["nuclei_blob_path"]

        # Read blob
        connection_string = os.environ.get("AzureStorageConnectionString")
        blob_service_client = BlobServiceClient.from_connection_string(connection_string)

        def read_blob(blob_path):
            path_parts = blob_path.split('/')
            container_name = path_parts[0]
            blob_name = '/'.join(path_parts[1:])
            blob_client = blob_service_client.get_container_client(container_name).get_blob_client(blob_name)
            return blob_client.download_blob().readall().decode('utf-8')

        nuclei_data = json.loads(read_blob(nuclei_blob_path))

        # Extract outputs
        nuclei_output = nuclei_data["data"]["output"]

        db_manager = DatabaseManager()
        result = await db_manager.store_vulnerability_scan_results(
            vulnerability_scan_id=scan_context["vuln_scan_id"],
            nuclei_output=nuclei_output
        )

        # Update total_vulnerabilities and scan_time_elapsed
        if result.get("success"):
            total_vulnerabilities = result.get("inserted", 0)
            summary_update = await db_manager.update_vulnerability_scan_summary(
                vulnerability_scan_id=scan_context["vuln_scan_id"],
                total_vulnerabilities=total_vulnerabilities
            )
            if summary_update.get("success"):
                logging.info(f"Updated vulnerability scan summary for id={scan_context['vuln_scan_id']}: total_vulnerabilities={total_vulnerabilities}")
            else:
                logging.error(f"Failed to update vulnerability scan summary: {summary_update.get('error')}")
        return result
    except Exception as e:
        logging.error(f"Failed to save vulnerability scan results: {str(e)}")
        logging.error(traceback.format_exc())
        return {"success": False, "error": str(e)} 